<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Imposter</title>
  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.55);

      --brand: #7c5cff;
      --brand-2: #2dd4bf;
      --danger: #ff4d4d;
      --success: #2ee59d;
      --gold: #ffd166;

      --shadow: 0 20px 50px rgba(0,0,0,0.45);
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,0.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(45,212,191,0.20), transparent 55%),
        radial-gradient(900px 500px at 60% 120%, rgba(255,209,102,0.10), transparent 60%),
        var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 28px 18px 70px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,92,255,0.9), rgba(45,212,191,0.75));
      box-shadow: 0 12px 28px rgba(124,92,255,0.22);
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    .brand .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
    }

    .pill{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap: 8px;
      align-items:center;
      user-select:none;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 700px){
      .grid.two{
        grid-template-columns: 1.05fr 0.95fr;
        align-items:start;
      }
    }

    h2{
      margin: 0 0 10px 0;
      font-size: 16px;
      color: rgba(255,255,255,0.92);
      letter-spacing: 0.2px;
    }
    .hint{
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
    }

    input, select, textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 15px;
      outline: none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.45); }

    .btn{
      width: 100%;
      border: 0;
      border-radius: 14px;
      padding: 13px 14px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.15s ease, opacity 0.15s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(0.99); }
    .btn-primary{
      background: linear-gradient(135deg, rgba(124,92,255,0.95), rgba(124,92,255,0.70));
      color: white;
    }
    .btn-secondary{
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: rgba(255,255,255,0.88);
    }
    .btn-success{
      background: linear-gradient(135deg, rgba(46,229,157,0.90), rgba(45,212,191,0.70));
      color: #061016;
    }
    .btn-danger{
      background: linear-gradient(135deg, rgba(255,77,77,0.95), rgba(255,77,77,0.70));
      color: white;
    }
    .btn:disabled{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 10px;
    }
    .player{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .player span{
      font-weight: 650;
      color: rgba(255,255,255,0.9);
    }
    .xbtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,77,77,0.35);
      background: rgba(255,77,77,0.12);
      color: rgba(255,255,255,0.95);
      font-size: 18px;
      cursor:pointer;
    }

    .error{
      color: rgba(255,77,77,0.95);
      font-weight: 650;
      font-size: 13px;
      margin-top: 10px;
      min-height: 18px;
    }

    /* Sections */
    .hidden{ display:none; }

    /* Pass / Peek screen */
    .passHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .titleBlock h3{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    .titleBlock p{
      margin: 6px 0 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .progress{
      text-align:right;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .bar{
      margin-top: 6px;
      height: 10px;
      width: 140px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(124,92,255,0.95), rgba(45,212,191,0.85));
    }

    .who{
      margin: 14px 0 10px;
      padding: 14px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .who .label{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .who .name{
      font-size: 26px;
      font-weight: 850;
      letter-spacing: 0.2px;
      background: linear-gradient(90deg, rgba(124,92,255,1), rgba(45,212,191,0.95));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .peekBtn{
      margin-top: 10px;
      padding: 16px 14px;
      border-radius: 18px;
      border: 1px solid rgba(124,92,255,0.35);
      background: rgba(124,92,255,0.14);
      color: rgba(255,255,255,0.95);
      font-weight: 850;
      font-size: 16px;
      cursor: pointer;
      user-select:none;
      box-shadow: 0 14px 40px rgba(124,92,255,0.18);
      touch-action: none; /* critical for mobile hold */
      transition: filter 0.15s ease, transform 0.08s ease;
    }
    .peekBtn:active{ transform: scale(0.99); }
    .peekBtn.pressing{
      filter: brightness(1.15);
    }

    .reveal{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }
    .reveal .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 520px){
      .reveal .grid2{ grid-template-columns: 0.9fr 1.1fr; }
    }

    .kv{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      text-align:left;
    }
    .kv .k{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 8px;
      letter-spacing: 0.2px;
    }
    .kv .v{
      font-size: 18px;
      font-weight: 900;
    }
    .kv .v.secret{
      color: var(--gold);
      font-size: 20px;
    }
    .kv .v.imposter{
      color: var(--danger);
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    .stack{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    /* Results */
    .resultBox{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      text-align:left;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      margin-bottom: 10px;
    }
    .badge.win{ border-color: rgba(46,229,157,0.35); background: rgba(46,229,157,0.12); color: rgba(46,229,157,0.95); }
    .badge.lose{ border-color: rgba(255,77,77,0.35); background: rgba(255,77,77,0.12); color: rgba(255,77,77,0.95); }

    .bigLine{
      font-size: 15px;
      color: rgba(255,255,255,0.88);
      margin: 6px 0;
      font-weight: 650;
    }
    .bigLine strong{ color: rgba(255,255,255,0.95); }

    /* Small util */
    .mt8{ margin-top: 8px; }
    .mt12{ margin-top: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Imposter</h1>
          <div class="sub">Local pass-and-play (one phone)</div>
        </div>
      </div>
      <div class="pill" id="pillStatus">Ready</div>
    </div>

    <!-- SETUP -->
    <div id="setupSection" class="grid two">
      <div class="card">
        <h2>Players</h2>
        <p class="hint">Add 3–10 names. The order will shuffle each round.</p>

        <div class="row">
          <input id="playerNameInput" type="text" placeholder="Enter name…" autocomplete="off" />
          <button class="btn btn-primary" style="max-width: 160px;" onclick="addPlayer()">Add</button>
        </div>

        <div class="list" id="playerList"></div>
      </div>

      <div class="card">
        <h2>Deck</h2>
        <p class="hint">Choose a CSV deck from your <code>/categories</code> folder.</p>

        <select id="categorySelect">
          <option value="" disabled selected>Loading categories…</option>
        </select>

        <button class="btn btn-success mt12" onclick="startGame()">Start Round</button>
        <div class="error" id="errorMsg"></div>
      </div>
    </div>

    <!-- PASS / PEEK -->
    <div id="passPhoneSection" class="hidden">
      <div class="card">
        <div class="passHeader">
          <div class="titleBlock">
            <h3>Pass the phone</h3>
            <p>Hand the phone to the player shown below. They must <strong>press and hold</strong> to view their role, then release to hide.</p>
          </div>
          <div class="progress">
            <div id="progressText">0 / 0</div>
            <div class="bar"><div id="progressFill"></div></div>
          </div>
        </div>

        <div class="who">
          <div class="label">Pass to</div>
          <div class="name" id="currentPlayerName">…</div>
        </div>

        <button id="peekBtn" class="peekBtn">Hold to peek</button>

        <div id="revealArea" class="reveal hidden">
          <div class="grid2">
            <div class="kv">
              <div class="k">ROLE</div>
              <div class="v" id="roleDisplay">…</div>
            </div>
            <div class="kv">
              <div class="k">SECRET</div>
              <div class="v secret" id="secretWord">…</div>
            </div>
          </div>
        </div>

        <div class="stack">
          <button id="nextBtn" class="btn btn-secondary hidden" onclick="advancePlayer()">Next player</button>
        </div>
      </div>
    </div>

    <!-- DISCUSSION -->
    <div id="discussionSection" class="hidden">
      <div class="card">
        <h2>Roles assigned</h2>
        <p class="hint">Start questioning. Civilians share clues without saying the secret. Imposter blends in.</p>

        <div class="divider"></div>

        <div class="bigLine">Starter: <strong id="starterName">…</strong></div>
        <button class="btn btn-danger mt12" onclick="goToVoting()">Vote now</button>
      </div>
    </div>

    <!-- VOTING -->
    <div id="votingSection" class="hidden">
      <div class="card">
        <h2>Vote</h2>
        <p class="hint">Select who the group voted out.</p>

        <select id="voteSelect"></select>
        <button class="btn btn-danger mt12" onclick="revealResult()">Confirm vote</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="resultSection" class="hidden">
      <div class="card">
        <h2>Results</h2>

        <div class="resultBox">
          <div id="resultBadge" class="badge">…</div>
          <div class="bigLine">Imposter: <strong id="actualImposterName">…</strong></div>
          <div class="bigLine">Secret: <strong id="actualSecretWord">…</strong></div>
        </div>

        <div class="divider"></div>

        <div class="stack">
          <button class="btn btn-success" onclick="resetGame(true)">Same players, new round</button>
          <button class="btn btn-secondary" onclick="resetGame(false)">Reset everything</button>
        </div>
      </div>
    </div>

  </div>

<script>
  let players = [];
  let gameQueue = [];
  let queueIndex = 0;

  let starterName = "";
  let actualImposter = "";
  let actualSecret = "";

  // Hold-to-peek state
  let holdTimer = null;
  let isRevealed = false;
  let hasPeekedThisTurn = false;

  const HOLD_DELAY_MS = 280; // small delay prevents accidental taps

  window.onload = async function() {
    try {
      const response = await fetch('/get_categories');
      const categories = await response.json();
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="" disabled selected>Select a deck…</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.text = prettifyDeckName(cat);
        select.appendChild(option);
      });
      setStatusPill("Ready");
    } catch (err) {
      console.error("Error loading categories", err);
      setStatusPill("Error");
    }

    wireHoldToPeek();
  };

  function prettifyDeckName(s){
    // nba_players -> NBA Players
    return s
      .replace(/_/g, ' ')
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  function setStatusPill(text){
    const pill = document.getElementById('pillStatus');
    pill.textContent = text;
  }

  function addPlayer() {
    const input = document.getElementById('playerNameInput');
    const name = input.value.trim();
    if (!name) return;

    if (!players.includes(name)) {
      players.push(name);
      updatePlayerList();
      input.value = '';
    }
  }

  function removePlayer(name) {
    players = players.filter(p => p !== name);
    updatePlayerList();
  }

  function updatePlayerList() {
    const list = document.getElementById('playerList');
    list.innerHTML = '';
    players.forEach(p => {
      const row = document.createElement('div');
      row.className = 'player';
      row.innerHTML = `
        <span>${escapeHtml(p)}</span>
        <button class="xbtn" onclick="removePlayer('${escapeAttr(p)}')">×</button>
      `;
      list.appendChild(row);
    });
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }
  function escapeAttr(str){
    return str.replace(/'/g, "\\'");
  }

  async function startGame() {
    const category = document.getElementById('categorySelect').value;
    const errorMsg = document.getElementById('errorMsg');

    errorMsg.textContent = "";

    if (players.length < 3) {
      errorMsg.textContent = "Need at least 3 players.";
      return;
    }
    if (!category) {
      errorMsg.textContent = "Select a deck.";
      return;
    }

    try {
      const response = await fetch('/setup_game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ players: players, category: category })
      });

      const data = await response.json();

      if (!response.ok) {
        errorMsg.textContent = data.error || "Could not start game.";
        return;
      }

      gameQueue = data.queue;
      starterName = data.starter;
      queueIndex = 0;

      // Store actual answers for end screen
      const imposterObj = gameQueue.find(p => p.role === 'IMPOSTER');
      actualImposter = imposterObj.player;
      const civilianObj = gameQueue.find(p => p.role === 'CIVILIAN');
      actualSecret = civilianObj.secret_word;

      setStatusPill("In round");
      showSection('passPhoneSection');
      updatePassPhoneCard();
    } catch (err) {
      errorMsg.textContent = "Connection error.";
    }
  }

  function updatePassPhoneCard() {
    const current = gameQueue[queueIndex];

    hasPeekedThisTurn = false;
    hideReveal();

    document.getElementById('currentPlayerName').textContent = current.player;

    // Progress UI
    const total = gameQueue.length;
    const idx = queueIndex + 1;
    document.getElementById('progressText').textContent = `${idx} / ${total}`;
    document.getElementById('progressFill').style.width = `${Math.round((idx / total) * 100)}%`;

    // Next button hidden until they peek once
    document.getElementById('nextBtn').classList.add('hidden');
  }

  function wireHoldToPeek(){
    const btn = document.getElementById('peekBtn');

    const startHold = (e) => {
      // Prevent long-press menu / scroll interactions
      e.preventDefault();

      // Allow re-peek until they hit Next (optional). If you want one-peek-only, uncomment:
      // if (hasPeekedThisTurn) return;

      btn.classList.add('pressing');

      clearTimeout(holdTimer);
      holdTimer = setTimeout(() => {
        revealNow();
      }, HOLD_DELAY_MS);
    };

    const endHold = (e) => {
      e.preventDefault();

      btn.classList.remove('pressing');
      clearTimeout(holdTimer);

      if (isRevealed) {
        hideReveal();
        hasPeekedThisTurn = true;
        // Now we allow them to pass phone and confirm they’re done
        document.getElementById('nextBtn').classList.remove('hidden');
      }
    };

    // Pointer events cover mouse + touch + pen
    btn.addEventListener('pointerdown', startHold);
    btn.addEventListener('pointerup', endHold);
    btn.addEventListener('pointercancel', endHold);
    btn.addEventListener('pointerleave', endHold);

    // Extra: prevent context menu on mobile
    btn.addEventListener('contextmenu', (e) => e.preventDefault());
  }
    document.getElementById('playerNameInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            addPlayer();
        }
    });

  function revealNow(){
    const current = gameQueue[queueIndex];

    document.getElementById('roleDisplay').textContent = current.role;
    document.getElementById('secretWord').textContent = current.secret_word;

    // Color cues
    const roleEl = document.getElementById('roleDisplay');
    const secretEl = document.getElementById('secretWord');

    roleEl.classList.remove('imposter');
    secretEl.classList.remove('imposter');

    if (current.role === 'IMPOSTER') {
      roleEl.classList.add('imposter');
      secretEl.classList.add('imposter');
    }

    document.getElementById('revealArea').classList.remove('hidden');
    isRevealed = true;

    // HAPTIC: short vibration on reveal (mobile)
    if (navigator.vibrate) navigator.vibrate(18);
    }

  function hideReveal(){
    document.getElementById('revealArea').classList.add('hidden');
    isRevealed = false;
  }

  function advancePlayer(){
    // Require at least one peek to move on (reduces “skip” mistakes)
    if (!hasPeekedThisTurn) return;

    queueIndex++;
    if (queueIndex < gameQueue.length) {
      updatePassPhoneCard();
    } else {
      document.getElementById('starterName').textContent = starterName;
      showSection('discussionSection');
    }
  }

  function goToVoting() {
    const select = document.getElementById('voteSelect');
    select.innerHTML = '';
    players.forEach(p => {
      const option = document.createElement('option');
      option.value = p;
      option.text = p;
      select.appendChild(option);
    });
    showSection('votingSection');
  }

  function revealResult() {
    const votedPlayer = document.getElementById('voteSelect').value;

    document.getElementById('actualImposterName').textContent = actualImposter;
    document.getElementById('actualSecretWord').textContent = actualSecret;

    const badge = document.getElementById('resultBadge');
    if (votedPlayer === actualImposter) {
      badge.className = "badge win";
      badge.textContent = "✅ Group wins — imposter caught";
    } else {
      badge.className = "badge lose";
      badge.textContent = "❌ Imposter wins — escaped";
    }

    setStatusPill("Finished");
    showSection('resultSection');
  }

  function resetGame(keepPlayers) {
    if (!keepPlayers) {
      players = [];
      updatePlayerList();
      document.getElementById('categorySelect').selectedIndex = 0;
    }
    document.getElementById('errorMsg').textContent = "";
    setStatusPill("Ready");
    showSection('setupSection');
  }

  function showSection(id) {
    ['setupSection','passPhoneSection','discussionSection','votingSection','resultSection'].forEach(s => {
      document.getElementById(s).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
  }
</script>
</body>
</html>
